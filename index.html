<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chia s·∫ª ·∫£nh c√πng L∆∞·ª£ng IT</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f6f8;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .upload-area {
        border: 2px dashed #007bff;
        padding: 40px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 30px;
        background: #f8fbff;
        transition: 0.3s;
      }
      .upload-area:hover {
        background: #eef5ff;
        border-color: #0056b3;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 15px;
        transition: 0.2s;
      }
      button:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 30px;
      }
      .card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .card-info {
        padding: 10px;
        font-size: 12px;
        color: #666;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>MiMEME</h2>

      <div class="upload-area">
        <input type="file" id="fileInput" accept="image/*" />
        <br />
        <button onclick="handleUpload()" id="btnUpload">
          T·∫£i ·∫£nh l√™n ngay
        </button>
        <p id="status" style="margin-top: 15px; color: #666">
          Ch·ªçn ·∫£nh v√† b·∫•m t·∫£i l√™n ƒë·ªÉ chia s·∫ª v·ªõi m·ªçi ng∆∞·ªùi
        </p>
      </div>

      <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px">
        ·∫¢nh m·ªçi ng∆∞·ªùi ƒë√£ ƒëƒÉng:
      </h3>
      <div class="gallery" id="gallery">
        <p>ƒêang t·∫£i danh s√°ch ·∫£nh...</p>
      </div>
    </div>

    <script type="module">
      // 1. Import th∆∞ vi·ªán Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // ============================================================
      // ‚ö†Ô∏è C·∫§U H√åNH C·ª¶A B·∫†N (ƒêI·ªÄN V√ÄO ƒê√ÇY)
      // ============================================================

      const IMGBB_API_KEY = "D√ÅN_KEY_IMGBB_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY";

      const firebaseConfig = {
        apiKey: "AIzaSyDV3K4aG4QBPYJRFD8ojRQJvIsOcd2UYbo",
        authDomain: "fir-web-meme.firebaseapp.com",
        projectId: "fir-web-meme",
        storageBucket: "fir-web-meme.firebasestorage.app",
        messagingSenderId: "71664214054",
        appId: "1:71664214054:web:59d079d78045181ece86e7",
        measurementId: "G-6YJGNV3FGD",
      };
      // ============================================================

      // Kh·ªüi t·∫°o Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Bi·∫øn to√†n c·ª•c ƒë·ªÉ d√πng trong h√†m html onclick
      window.handleUpload = async function () {
        const fileInput = document.getElementById("fileInput");
        const status = document.getElementById("status");
        const btn = document.getElementById("btnUpload");
        const file = fileInput.files[0];

        if (!file) {
          alert("Ch∆∞a ch·ªçn ·∫£nh!");
          return;
        }

        btn.disabled = true;
        status.innerText = "‚è≥ ƒêang upload l√™n ImgBB...";

        try {
          // B1: Upload l√™n ImgBB
          const formData = new FormData();
          formData.append("image", file);
          const res = await fetch(
            `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,
            { method: "POST", body: formData }
          );
          const data = await res.json();

          if (!data.success) throw new Error("L·ªói ImgBB: " + data.status_txt);

          // B2: L∆∞u link v√†o Firebase
          status.innerText = "üíæ ƒêang l∆∞u v√†o Database chung...";
          await addDoc(collection(db, "images"), {
            url: data.data.url,
            createdAt: serverTimestamp(), // L∆∞u th·ªùi gian t·∫°o
          });

          status.innerText = "‚úÖ Th√†nh c√¥ng!";
          fileInput.value = "";
          loadImages(); // T·∫£i l·∫°i danh s√°ch ngay l·∫≠p t·ª©c
        } catch (error) {
          console.error(error);
          status.innerText = "‚ùå L·ªói: " + error.message;
        } finally {
          btn.disabled = false;
        }
      };

      // H√†m t·∫£i danh s√°ch ·∫£nh t·ª´ Firebase
      async function loadImages() {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "<p>ƒêang c·∫≠p nh·∫≠t...</p>";

        try {
          // L·∫•y danh s√°ch ·∫£nh, s·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu
          const q = query(
            collection(db, "images"),
            orderBy("createdAt", "desc")
          );
          const querySnapshot = await getDocs(q);

          gallery.innerHTML = ""; // X√≥a ch·ªØ ƒëang t·∫£i

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const card = `
                        <div class="card">
                            <a href="${data.url}" target="_blank">
                                <img src="${data.url}" loading="lazy" alt="·∫¢nh chia s·∫ª">
                            </a>
                        </div>
                    `;
            gallery.innerHTML += card;
          });
        } catch (error) {
          console.error(error);
          gallery.innerHTML =
            '<p style="color:red">L·ªói t·∫£i ·∫£nh (B·∫°n ƒë√£ b·∫≠t "Test Mode" trong Firebase ch∆∞a?)</p>';
        }
      }

      // T·ª± ƒë·ªông t·∫£i ·∫£nh khi v√†o web
      loadImages();
    </script>
  </body>
</html>
